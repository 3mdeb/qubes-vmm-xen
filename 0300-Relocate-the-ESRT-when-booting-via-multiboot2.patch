From 903eb78c5a3ee51e8692bddf354d6e840dd4947f Mon Sep 17 00:00:00 2001
Message-Id: <903eb78c5a3ee51e8692bddf354d6e840dd4947f.1671229737.git.demi@invisiblethingslab.com>
In-Reply-To: <cover.1671229737.git.demi@invisiblethingslab.com>
References: <cover.1671229737.git.demi@invisiblethingslab.com>
From: Demi Marie Obenour <demi@invisiblethingslab.com>
Date: Thu, 8 Dec 2022 19:25:43 -0500
Subject: [PATCH 2/2] Relocate the ESRT when booting via multiboot2
Cc: Marek Marczykowski-GÃ³recki <marmarek@invisiblethingslab.com>

This was missed in the initial patchset.  The patch sent upstream is
larger and involves significant code movement.  I added a forward
declaration instead.

Signed-off-by: Demi Marie Obenour <demi@invisiblethingslab.com>
---
 xen/arch/x86/efi/efi-boot.h | 2 ++
 xen/common/efi/boot.c       | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/xen/arch/x86/efi/efi-boot.h b/xen/arch/x86/efi/efi-boot.h
index abfc7ab0f31511e2c1ee402a09ac533d260444b2..a9a2991d6462dec9cea695c8b912b72df26bd511 100644
--- a/xen/arch/x86/efi/efi-boot.h
+++ b/xen/arch/x86/efi/efi-boot.h
@@ -825,6 +825,8 @@ void __init efi_multiboot2(EFI_HANDLE ImageHandle, EFI_SYSTEM_TABLE *SystemTable
     if ( gop )
         efi_set_gop_mode(gop, gop_mode);
 
+    efi_relocate_esrt(SystemTable);
+
     efi_exit_boot(ImageHandle, SystemTable, true);
 }
 
diff --git a/xen/common/efi/boot.c b/xen/common/efi/boot.c
index 32ae6b43bb53448421c908819cda552757157c1f..dac3247590fc5485b64d538a564675fe70f7a3f6 100644
--- a/xen/common/efi/boot.c
+++ b/xen/common/efi/boot.c
@@ -588,6 +588,8 @@ static int __init efi_check_dt_boot(const EFI_LOADED_IMAGE *loaded_image)
 }
 #endif
 
+static void __init efi_relocate_esrt(EFI_SYSTEM_TABLE *SystemTable);
+
 static UINTN __initdata esrt = EFI_INVALID_TABLE_ADDR;
 
 static size_t __init get_esrt_size(const EFI_MEMORY_DESCRIPTOR *desc)
-- 
Sincerely,
Demi Marie Obenour (she/her/hers)
Invisible Things Lab

